services:
  backend:
    image: ${REGISTRY}/lems:backend-${IMAGE_TAG}
    ports:
      - '3333:3333'
    networks:
      - lems-network
    restart: always
    environment:
      # Frontend (Future use)
      # - LEMS_DOMAIN=${LEMS_DOMAIN}

      # Authentication
      - RECAPTCHA=${RECAPTCHA}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - FIRST_ISRAEL_DASHBOARD_SECRET=${FIRST_ISRAEL_DASHBOARD_SECRET}

      # Database connection
      - DB_NAME=${DB_NAME}
      - MONGODB_URI=${MONGODB_URI}
      - PG_HOST=${PG_HOST}
      - PG_PORT=${PG_PORT}
      - PG_USER=${PG_USER}
      - PG_PASSWORD=${PG_PASSWORD}
      - PG_SSL_CA=${PG_SSL_CA}

      # Redis Configuration
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB}

      # Scheduler
      - SCHEDULER_URL=${SCHEDULER_URL}
      - SCHEDULER_JWT_SECRET=${SCHEDULER_JWT_SECRET}

      # Cloud storage
      - DIGITALOCEAN_ENDPOINT=${DIGITALOCEAN_ENDPOINT}
      - DIGITALOCEAN_SPACE=${DIGITALOCEAN_SPACE}
      - DIGITALOCEAN_KEY=${DIGITALOCEAN_KEY}
      - DIGITALOCEAN_SECRET=${DIGITALOCEAN_SECRET}

      # Integrations
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}

  admin:
    image: ${REGISTRY}/lems:admin-${IMAGE_TAG}
    ports:
      - '4201:4201'
    networks:
      - lems-network
    restart: always
    environment:
      # Note: NEXT_PUBLIC_* variables must be set at build time and are embedded in the bundle
      # The admin app uses NEXT_PUBLIC_BASE_URL which was set during docker build
      
      # Runtime environment variables for server-side only features:
      - LOCAL_BASE_URL=${LOCAL_BASE_URL}
      - RECAPTCHA=${RECAPTCHA}

  frontend:
    image: ${REGISTRY}/lems:frontend-${IMAGE_TAG}
    ports:
      - '4200:4200'
    networks:
      - lems-network
    restart: always
    environment:
      # Note: NEXT_PUBLIC_* variables must be set at build time and are embedded in the bundle
      # The frontend app uses NEXT_PUBLIC_BASE_URL which was set during docker build
      
      # Runtime environment variables for server-side only features:
      - LOCAL_BASE_URL=${LOCAL_BASE_URL}
      - RECAPTCHA=${RECAPTCHA}

  portal:
    image: ${REGISTRY}/lems:portal-${IMAGE_TAG}
    ports:
      - '3000:3000'
    networks:
      - lems-network
    restart: always
    environment:
      # Note: NEXT_PUBLIC_* variables must be set at build time and are embedded in the bundle
      # The portal app uses NEXT_PUBLIC_BASE_URL which was set during docker build
      
      # Runtime environment variables for server-side only features:
      - LOCAL_BASE_URL=${LOCAL_BASE_URL}

  scheduler:
    image: ${REGISTRY}/lems:scheduler-${IMAGE_TAG}
    ports:
      - '8000:8000'
    networks:
      - lems-network
    restart: always
    environment:
      - LOCAL_BASE_URL=${LOCAL_BASE_URL}
      - SCHEDULER_JWT_SECRET=${SCHEDULER_JWT_SECRET}

networks:
  lems-network:
    driver: bridge
