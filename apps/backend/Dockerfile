FROM node:22-alpine

ENV HOST=0.0.0.0
ENV PORT=3333
ENV NODE_ENV=production

# Database configuration
ARG DB_NAME
ENV DB_NAME=$DB_NAME
ARG MONGODB_URI
ENV MONGODB_URI=$MONGODB_URI
ARG PG_HOST
ENV PG_HOST=$PG_HOST
ARG PG_PORT
ENV PG_PORT=$PG_PORT
ARG PG_USER
ENV PG_USER=$PG_USER
ARG PG_PASSWORD
ENV PG_PASSWORD=$PG_PASSWORD

# Authentication & Security
ARG JWT_SECRET
ENV JWT_SECRET=$JWT_SECRET
ARG DASHBOARD_JWT_SECRET
ENV DASHBOARD_JWT_SECRET=$DASHBOARD_JWT_SECRET
ARG SCHEDULER_JWT_SECRET
ENV SCHEDULER_JWT_SECRET=$SCHEDULER_JWT_SECRET
ARG RECAPTCHA
ENV RECAPTCHA=$RECAPTCHA
ARG RECAPTCHA_SECRET_KEY
ENV RECAPTCHA_SECRET_KEY=$RECAPTCHA_SECRET_KEY

# External Services
ARG LEMS_DOMAIN
ENV LEMS_DOMAIN=$LEMS_DOMAIN
ARG SCHEDULER_URL
ENV SCHEDULER_URL=$SCHEDULER_URL

# Cloud Storage (DigitalOcean Spaces)
ARG DIGITALOCEAN_ENDPOINT
ENV DIGITALOCEAN_ENDPOINT=$DIGITALOCEAN_ENDPOINT
ARG DIGITALOCEAN_SPACE
ENV DIGITALOCEAN_SPACE=$DIGITALOCEAN_SPACE
ARG DIGITALOCEAN_KEY
ENV DIGITALOCEAN_KEY=$DIGITALOCEAN_KEY
ARG DIGITALOCEAN_SECRET
ENV DIGITALOCEAN_SECRET=$DIGITALOCEAN_SECRET

WORKDIR /app

RUN addgroup -S lems && adduser -S backend -G lems

COPY dist/apps/backend backend
RUN chown -R backend:lems .

# Install Chromium for Puppeteer
RUN apk add --no-cache \
  chromium \
  nss \
  freetype \
  harfbuzz \
  ca-certificates \
  ttf-freefont

ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app/backend
RUN npm i --omit=dev && npx puppeteer browsers install chrome

# Setup Puppeteer directories
RUN mkdir -p /home/backend/Downloads /app && \
  chown -R backend:lems /home/backend && \
  chown -R backend:lems /app

USER backend

EXPOSE 3333

CMD ["node", "main.js"]

