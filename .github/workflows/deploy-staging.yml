name: Deploy to Staging

on:
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com/first-israel-registry
  IMAGE_TAG: staging-${{ github.sha }}

jobs:
  build-backend:
    name: Build & Push Backend
    uses: ./.github/workflows/deploy-backend.yml
    with:
      environment: staging
      image_tag: staging-${{ github.sha }}
      registry: registry.digitalocean.com/first-israel-registry
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      DIGITALOCEAN_KEY: ${{ secrets.DIGITALOCEAN_KEY }}
      DIGITALOCEAN_SECRET: ${{ secrets.DIGITALOCEAN_SECRET }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      DASHBOARD_JWT_SECRET: ${{ secrets.DASHBOARD_JWT_SECRET }}
      SCHEDULER_JWT_SECRET: ${{ secrets.SCHEDULER_JWT_SECRET }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}

  cleanup-old-images:
    name: Cleanup Old Staging Images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    needs: build-backend
    
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2.5.1
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600
      
      - name: Remove old staging images
        run: |
          cleanup_repository() {
            local repo_name=$1
            echo "ðŸ” Cleaning up repository: $repo_name"
            
            local tags_and_digests=$(doctl registry repository list-tags "$repo_name" --format Tag,ManifestDigest --no-header 2>/dev/null || true)
            
            if [ -z "$tags_and_digests" ]; then
              echo "âœ“ No images found in $repo_name"
              return
            fi
            
            echo "$tags_and_digests" | while IFS=$'\t' read -r tag digest; do
              # Only delete staging tags, skip the current deployment
              if [[ "$tag" == staging-* ]] && [[ "$tag" != "${{ env.IMAGE_TAG }}" ]]; then
                echo "ðŸ—‘ï¸  Deleting $tag (digest: $digest)"
                if [ -n "$digest" ]; then
                  doctl registry repository delete-manifest "$repo_name" "$digest" --force || echo "âš ï¸  Failed to delete $tag"
                else
                  echo "âš ï¸  Empty digest for tag $tag"
                fi
              else
                echo "â© Skipping tag: $tag"
              fi
            done
            
            echo "âœ“ Cleaned up $repo_name"
          }
          
          cleanup_repository "lems-backend"
      
      - name: Run garbage collection
        run: doctl registry garbage-collection start --force

  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: staging
    needs: cleanup-old-images
    
    steps:
      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@25ce8cbbcb08177468c7ff7ec5cbfa236f9341e1 # v1.2.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          # Database configuration
          DB_NAME: ${{ vars.DB_NAME }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          PG_HOST: ${{ vars.PG_HOST }}
          PG_PORT: ${{ vars.PG_PORT }}
          PG_USER: ${{ vars.PG_USER }}
          PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
          # Authentication & Security
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DASHBOARD_JWT_SECRET: ${{ secrets.DASHBOARD_JWT_SECRET }}
          SCHEDULER_JWT_SECRET: ${{ secrets.SCHEDULER_JWT_SECRET }}
          RECAPTCHA: ${{ vars.RECAPTCHA }}
          RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
          # External Services
          LEMS_DOMAIN: ${{ vars.LEMS_DOMAIN }}
          SCHEDULER_URL: ${{ vars.SCHEDULER_URL }}
          # Cloud Storage (DigitalOcean Spaces)
          DIGITALOCEAN_ENDPOINT: ${{ vars.DIGITALOCEAN_ENDPOINT }}
          DIGITALOCEAN_SPACE: ${{ vars.DIGITALOCEAN_SPACE }}
          DIGITALOCEAN_KEY: ${{ secrets.DIGITALOCEAN_KEY }}
          DIGITALOCEAN_SECRET: ${{ secrets.DIGITALOCEAN_SECRET }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSHKEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          envs: REGISTRY,IMAGE_TAG,DB_NAME,MONGODB_URI,PG_HOST,PG_PORT,PG_USER,PG_PASSWORD,JWT_SECRET,DASHBOARD_JWT_SECRET,SCHEDULER_JWT_SECRET,RECAPTCHA,RECAPTCHA_SECRET_KEY,LEMS_DOMAIN,SCHEDULER_URL,DIGITALOCEAN_ENDPOINT,DIGITALOCEAN_SPACE,DIGITALOCEAN_KEY,DIGITALOCEAN_SECRET
          script: |
            echo "ðŸ” Logging into DigitalOcean registry..."
            docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} registry.digitalocean.com
            
            echo "ðŸ“‚ Navigating to project directory..."
            cd lems
            
            echo "ðŸ›‘ Stopping existing containers..."
            docker compose down
            
            echo "ðŸ§¹ Cleaning up old containers and images..."
            docker compose rm -f
            docker rmi $(docker images --filter "reference=*lems-*" -q) 2>/dev/null || echo "No old images to remove"
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard ${{ github.sha }}
            
            echo "ðŸš€ Starting services..."
            docker compose up -d
            
            echo "âœ… Deployment complete!"
