name: Cleanup Registry Images

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository name to clean up'
        required: true
        type: string
      tag_pattern:
        description: 'Tag pattern to match for deletion (e.g., "staging-*" or "v*-beta")'
        required: true
        type: string
      exclude_tag:
        description: 'Tag to exclude from deletion (e.g., current deployment)'
        required: false
        type: string
        default: ''
      run_garbage_collection:
        description: 'Whether to run garbage collection after cleanup'
        required: false
        type: boolean
        default: true
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN:
        required: true

jobs:
  cleanup:
    name: Cleanup ${{ inputs.repository }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2.5.1
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600
      
      - name: Remove old images matching pattern
        run: |
          # Function to clean up old images for a repository
          cleanup_repository() {
            local repo_name=$1
            echo "Cleaning up repository: $repo_name"
            
            local tags_and_digests=$(doctl registry repository list-tags "$repo_name" --format Tag,ManifestDigest --no-header 2>/dev/null || true)
            
            echo "Debug: Raw output of list-tags command for $repo_name:"
            echo "$tags_and_digests"
            
            if [ -n "$tags_and_digests" ]; then
              echo "Found tags and digests to delete:"
              echo "$tags_and_digests" | while read -r line; do
                tag=$(echo "$line" | awk '{print $1}') # Extract tag from the first column
                digest=$(echo "$line" | awk '{print $2}') # Extract digest from the second column
                if [[ "$tag" == staging-* ]]; then # Only process tags starting with 'staging-'
                  echo "Tag: $tag, Digest: $digest"
                  if [ -n "$digest" ]; then
                    doctl registry repository delete-manifest "$repo_name" "$digest" --force
                  else
                    echo "Warning: Empty digest for tag $tag in repository $repo_name" >&2
                  fi
                else
                  echo "Skipping tag $tag as it does not start with 'staging-'"
                fi
              done
              echo "‚úì Cleaned up $repo_name"
            else
              echo "‚úì No old images found in $repo_name"
            fi
          }
          
          # Clean up all repositories
          for repo in lems-frontend lems-backend lems-scheduler lems-portal; do
            cleanup_repository "$repo"
          done
      
      - name: Run garbage collection
        if: ${{ inputs.run_garbage_collection }}
        run: |
          echo "üóëÔ∏è  Starting garbage collection..."
          doctl registry garbage-collection start --force
          echo "‚úì Garbage collection started"