name: Cleanup Registry Images

on:
  workflow_call:
    inputs:
      tag_pattern:
        description: 'Pattern to match tags for deletion (supports bash regex)'
        required: true
        type: string
      exclude_pattern:
        description: 'Pattern to exclude from deletion (supports bash regex)'
        required: false
        type: string
        default: ''
    secrets:
      DIGITALOCEAN_ACCESS_TOKEN:
        required: true

permissions: {}

jobs:
  cleanup:
    name: Cleanup old images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2.5.1
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      
      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600
      
      - name: Delete matching image manifests
        run: |
          set -euo pipefail
          
          REPOSITORY="lems"
          TAG_PATTERN=${{ inputs.tag_pattern }}
          EXCLUDE_PATTERN=${{ inputs.exclude_pattern }}
          
          echo "üîç Fetching tags from repository: $REPOSITORY"
          echo "üìã Tag pattern: $TAG_PATTERN"
          echo "üö´ Exclude pattern: $EXCLUDE_PATTERN"
          tags=$(doctl registry repository list-tags "$REPOSITORY" --output json)
          
          echo "üì¶ Found tags:"
          echo "$tags" | jq -r '.[].tag' | head -20
          echo ""
          
          DELETED_COUNT=0
          echo "$tags" | jq -r '.[] | select(.manifest_digest != null and .manifest_digest != "") | "\(.tag)|\(.manifest_digest)"' | while IFS='|' read -r tag digest; do
            # Check if tag matches include pattern
            if [[ ! "$tag" =~ $TAG_PATTERN ]]; then
              echo "‚è≠Ô∏è  Skipping non-matching: $tag"
              continue
            fi
            
            # Check if tag matches exclude pattern
            if [[ -n "$EXCLUDE_PATTERN" ]] && [[ "$tag" =~ $EXCLUDE_PATTERN ]]; then
              echo "‚è≠Ô∏è  Skipping excluded: $tag"
              continue
            fi
            
            # Ensure digest has sha256: prefix
            if [[ ! "$digest" =~ ^sha256: ]]; then
              digest="sha256:${digest}"
            fi
            
            # Delete manifest by digest
            echo "üóëÔ∏è  Deleting: $tag (digest: $digest)"
            doctl registry repository delete-manifest "$REPOSITORY" "$digest" --force
            DELETED_COUNT=$((DELETED_COUNT + 1))
          done
          
          echo ""
          echo "‚úÖ Cleanup complete - deleted $DELETED_COUNT image(s)"
      
      - name: Run garbage collection
        run: |
          echo "üóëÔ∏è  Starting garbage collection..."
          doctl registry garbage-collection start --force
          echo "‚úÖ Garbage collection initiated"
